<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mungtrainer.mtserver.counseling.dao.TrainerUserDAO">


    <!-- =======================
         ResultMap 정의
         ======================= -->
    <resultMap id="MultiCourseWithSessions" type="com.mungtrainer.mtserver.counseling.dto.response.MultiCourseGroupResponse">
        <id property="courseId" column="courseId"/>
        <result property="title" column="title"/>
        <result property="tags" column="tags"/>
        <result property="description" column="description"/>
        <result property="location" column="location"/>
        <result property="type" column="type"/>
        <result property="difficulty" column="difficulty"/>
        <result property="mainImage" column="mainImage"/>
        <result property="totalSessions" column="totalSessions"/>
        <result property="attendedSessions" column="attendedSessions"/>
        <result property="attendanceRate" column="attendanceRate"/>

        <!-- 세션 리스트 매핑 -->
        <collection property="sessions" ofType="com.mungtrainer.mtserver.counseling.dto.response.MultiSessionResponse">
            <id property="sessionId" column="sessionId"/>
            <result property="sessionNo" column="sessionNo"/>
            <result property="sessionDate" column="sessionDate"/>
            <result property="startTime" column="startTime"/>
            <result property="endTime" column="endTime"/>
            <result property="locationDetail" column="locationDetail"/>
            <result property="attendanceStatus" column="attendanceStatus"/>
        </collection>
    </resultMap>


    <!-- 훈련사가 관리하는 회원 목록 조회 -->
    <select id="findUsersByTrainerId"
            resultType="com.mungtrainer.mtserver.counseling.dto.response.TrainerUserListResponse">
        SELECT
        u.user_id AS userId,
        u.name AS name,
        u.phone AS phone,
        u.email AS email
        FROM trainer_user tu
        JOIN user u ON tu.user_id = u.user_id
        WHERE tu.trainer_id = #{trainerId}
        AND tu.is_deleted = 0
        AND u.is_deleted = 0
        ORDER BY u.created_at DESC
    </select>

<!--    특정 반려견이 신청한 과정 중 같은 tags 기준으로 몇 회차 들었는지 조회-->
    <select id="findTrainingApplicationsByDogId"
            resultType="com.mungtrainer.mtserver.counseling.dto.response.TrainingApplicationResponse">
        SELECT
        c.course_id,
        c.title AS course_title,
        c.description AS course_description,
        c.tags,
        c.type,

        s.session_id,
        s.session_date,
        s.start_time AS session_start_time,
        s.end_time AS session_end_time,

        COUNT(a.application_id) OVER (PARTITION BY c.tags) AS times_applied,


        attended.attended_count,

        ta.`status` AS attendance_status

        FROM training_course c
        JOIN training_session s ON s.course_id = c.course_id
        JOIN training_course_application a ON a.session_id = s.session_id
        LEFT JOIN training_attendance ta
        ON ta.application_id = a.application_id
        AND ta.is_deleted = 0

<!--    ATTENDED 개수를 course.tags 기준으로 미리 group by 해서 가져오기-->
        LEFT JOIN (
        SELECT
        c2.tags,
        COUNT(ta2.attendance_id) AS attended_count
        FROM training_course c2
        JOIN training_session s2 ON s2.course_id = c2.course_id
        JOIN training_course_application a2 ON a2.session_id = s2.session_id
        JOIN training_attendance ta2 ON ta2.application_id = a2.application_id
        WHERE ta2.status = 'ATTENDED'
        GROUP BY c2.tags
        ) attended ON attended.tags = c.tags

        WHERE a.dog_id = #{dogId}
        AND c.is_deleted = 0
        AND a.is_deleted = 0
        AND c.type != 'MULTI'

        ORDER BY c.tags, s.session_date;
    </select>

<!--    신청한 다회차(MULTI) course 목록-->
    <select id="findMultiCoursesByDogId"
            parameterType="long"
            resultType="com.mungtrainer.mtserver.counseling.dto.response.MultiCourseGroupResponse">

        SELECT DISTINCT
        tc.course_id AS courseId,
        tc.title,
        tc.tags,
        tc.description,
        tc.location,
        tc.type,
        tc.difficulty,
        tc.main_image AS mainImage
        FROM training_course tc
        JOIN training_session ts
        ON tc.course_id = ts.course_id
        JOIN training_course_application tca
        ON ts.session_id = tca.session_id
        WHERE tca.dog_id = #{dogId}
        AND tc.type = 'MULTI'
        AND tc.is_deleted = 0
    </select>

    <select id="findSessionsWithAttendance"
            parameterType="map"
            resultType="com.mungtrainer.mtserver.counseling.dto.response.MultiSessionResponse">

        SELECT
        ts.session_id AS sessionId,
        ts.session_no AS sessionNo,
        ts.session_date AS sessionDate,
        ts.start_time AS startTime,
        ts.end_time AS endTime,
        ts.location_detail AS locationDetail,
        ta.status AS attendanceStatus
        FROM training_session ts
        LEFT JOIN training_course_application tca
        ON ts.session_id = tca.session_id
        AND tca.dog_id = #{dogId}
        LEFT JOIN training_attendance ta
        ON tca.application_id = ta.application_id
        WHERE ts.course_id = #{courseId}
        ORDER BY ts.session_no

    </select>


    <!-- =======================
        다회차 과정 + 세션 + 출석
        ======================= -->
    <select id="findMultiCourseDetail"
            parameterType="map"
            resultMap="MultiCourseWithSessions">

        SELECT
        tc.course_id AS courseId,
        tc.title,
        tc.tags,
        tc.description,
        tc.location,
        tc.type,
        tc.difficulty,
        tc.main_image AS mainImage,
        ts.session_id AS sessionId,
        ts.session_no AS sessionNo,
        ts.session_date AS sessionDate,
        ts.start_time AS startTime,
        ts.end_time AS endTime,
        ts.location_detail AS locationDetail,
        ta.status AS attendanceStatus,
        sub.totalSessions AS totalSessions,
        sub.attendedSessions AS attendedSessions,
        (CASE WHEN sub.totalSessions = 0 THEN 0 ELSE sub.attendedSessions * 100.0 / sub.totalSessions END) AS attendanceRate
        FROM training_course tc
        JOIN training_session ts ON tc.course_id = ts.course_id
        JOIN training_course_application tca
        ON ts.session_id = tca.session_id
        AND tca.dog_id = #{dogId}
        LEFT JOIN training_attendance ta ON ta.application_id = tca.application_id
        LEFT JOIN (
        SELECT
        ts2.course_id,
        COUNT(DISTINCT ts2.session_id) AS totalSessions,
        COUNT(DISTINCT CASE WHEN ta2.status = 'PRESENT' THEN ts2.session_id END) AS attendedSessions
        FROM training_session ts2
        JOIN training_course_application tca2
        ON ts2.session_id = tca2.session_id
        AND tca2.dog_id = #{dogId}
        LEFT JOIN training_attendance ta2 ON tca2.application_id = ta2.application_id
        GROUP BY ts2.course_id
        ) sub ON sub.course_id = tc.course_id
        WHERE tc.type = 'MULTI'
        AND tc.is_deleted = 0
        ORDER BY tc.course_id, ts.session_no
    </select>




    <!--    출석률 계산용 count 쿼리-->
<!--    총 회차 수-->
    <select id="countSessionsByCourseId"
            parameterType="long"
            resultType="int">
        SELECT COUNT(*)
        FROM training_session
        WHERE course_id = #{courseId}
    </select>

<!--    출석한 회차 수-->
    <select id="countAttendedSessions"
            parameterType="map"
            resultType="int">

        SELECT COUNT(*)
        FROM training_attendance ta
        JOIN training_course_application tca
        ON ta.application_id = tca.application_id
        JOIN training_session ts
        ON tca.session_id = ts.session_id
        WHERE tca.dog_id = #{dogId}
        AND ts.course_id = #{courseId}
        AND ta.status = 'PRESENT'
    </select>


<!--    승인 대기 목록-->
    <select id="selectWaitingApplications" resultType="com.mungtrainer.mtserver.counseling.dto.response.AppliedWaitingResponse">
        SELECT
        d.name AS dogName,
        u.name AS ownerName,
        tc.title AS courseTitle,
        ts.session_date AS sessionDate,
        ts.start_time AS startTime,
        ts.end_time AS endTime
        FROM training_course_application tca
        JOIN dog d ON tca.dog_id = d.dog_id
        JOIN user u ON d.user_id = u.user_id
        JOIN training_session ts ON tca.session_id = ts.session_id
        JOIN training_course tc ON ts.course_id = tc.course_id
        WHERE tca.status = 'APPLIED'
        AND tca.is_deleted = 0
        AND d.is_deleted = 0
        AND u.is_deleted = 0
        AND ts.is_deleted = 0
        AND tc.is_deleted = 0
        ORDER BY ts.session_date, ts.start_time;
    </select>

<!--    승인, 거절(거절사유)-->
<!--    승인-->
    <update id="updateStatusApproved">
        UPDATE training_course_application
        SET
        status = 'ACCEPT',
        updated_by = #{trainerId},
        updated_at = NOW()
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
        AND status = 'APPLIED';
    </update>


    <!--    거절-->
    <update id="updateStatusRejected">
        UPDATE training_course_application
        SET
        status = 'REJECTED',
        reject_reason = #{rejectReason},
        updated_by = #{trainerId},
        updated_at = NOW()
        WHERE application_id = #{applicationId}
        AND is_deleted = 0
        AND status = 'APPLIED';
    </update>


</mapper>